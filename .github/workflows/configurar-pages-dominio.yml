name: Configurar Pages y Dominio

on:
  push:
    branches:
      - main
    paths:
      - CNAME
      - .github/workflows/configurar-pages-dominio.yml
  workflow_dispatch:

permissions:
  contents: read
  pages: write

jobs:
  configurar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Aplicar build_type y custom domain
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -f CNAME ]]; then
            echo "No existe archivo CNAME"
            exit 1
          fi

          DOMAIN="$(tr -d '\r\n ' < CNAME)"
          if [[ -z "${DOMAIN}" ]]; then
            echo "CNAME esta vacio"
            exit 1
          fi

          echo "Configurando Pages para ${REPO}"
          echo "Dominio: ${DOMAIN}"

          # 1) Activar GitHub Actions como fuente de Pages
          gh api "repos/${REPO}/pages" -X PUT -f build_type=workflow >/dev/null

          # 2) Forzar dominio personalizado desde CNAME del repo
          gh api "repos/${REPO}/pages" -X PUT -f cname="${DOMAIN}" >/dev/null

          # 3) Mostrar estado final
          gh api "repos/${REPO}/pages" --jq '{status,build_type,cname,html_url,https_enforced}'

